<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Education AI Prototype</title>
    <style>
        body { font-family: sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; }
        .container { display: flex; flex-direction: column; gap: 20px; }
        .section { border: 1px solid #ccc; padding: 15px; border-radius: 8px; }
        .row { display: flex; gap: 10px; align-items: flex-start; }
        video, canvas { border: 1px solid #333; background: #000; }
        pre { background: #f0f0f0; padding: 10px; overflow-x: auto; }
        .hidden { display: none; }
    </style>
</head>
<body>
    <h1>Education AI Assistant Prototype</h1>
    
    <div class="container">
        <!-- Video / Image Capture -->
        <div class="section">
            <h3>1. Student Feed</h3>
            <div class="row">
                <div>
                    <video id="video" width="320" height="240" autoplay></video>
                    <br>
                    <button id="snap">Capture Photo</button>
                </div>
                <div>
                    <canvas id="canvas" width="320" height="240"></canvas>
                </div>
            </div>
        </div>

        <!-- Inputs -->
        <div class="section">
            <h3>2. Question & Context</h3>
            <label>Question:</label>
            <input type="text" id="query" value="Why is the sky blue?" style="width: 100%; margin-bottom: 10px;">
            
            <label>Mock Transcript:</label>
            <textarea id="transcript" rows="2" style="width: 100%;">Teacher: Today we are talking about light scattering.</textarea>
            
            <label>Chat History (JSON):</label>
            <textarea id="history" rows="2" style="width: 100%;">[]</textarea>
        </div>

        <!-- Controls -->
        <div class="section">
            <h3>3. Action</h3>
            <button id="btnAsk">Ask (Standard)</button>
            <button id="btnStream">Ask (Stream)</button>
        </div>

        <!-- Results -->
        <div class="section">
            <h3>4. Results</h3>
            <div id="loading" class="hidden">Thinking...</div>
            
            <h4>Lesson Relevance</h4>
            <pre id="resEmotion">...</pre>
            
            <h4>Question Quality</h4>
            <pre id="resQuality">...</pre>
            
            <h4>Tutor Response</h4>
            <div id="resTutor" style="white-space: pre-wrap; background: #eef; padding: 10px;">...</div>
        </div>
    </div>

    <script>
        // Webcam Setup
        const video = document.getElementById('video');
        const canvas = document.getElementById('canvas');
        const context = canvas.getContext('2d');
        
        navigator.mediaDevices.getUserMedia({ video: true })
            .then(stream => { video.srcObject = stream; })
            .catch(err => { console.error("Webcam error:", err); alert("Webcam access denied or error."); });

        document.getElementById('snap').addEventListener('click', () => {
            context.drawImage(video, 0, 0, 320, 240);
        });

        // API Interaction
        async function sendRequest(stream = false) {
            const query = document.getElementById('query').value;
            const transcript = document.getElementById('transcript').value;
            const history = document.getElementById('history').value;
            
            // Get base64 data URL (e.g. "data:image/jpeg;base64,...")
            const dataUrl = canvas.toDataURL('image/jpeg', 0.9);
            if (!dataUrl || dataUrl === 'data:,') { alert("Please capture an image first!"); return; }

            const formData = new FormData();
            formData.append('query', query);
            formData.append('transcript', transcript);
            formData.append('chat_history', history);
            formData.append('image_base64', dataUrl);

            document.getElementById('loading').classList.remove('hidden');
            document.getElementById('resEmotion').textContent = '...';
            document.getElementById('resQuality').textContent = '...';
            document.getElementById('resTutor').textContent = '...';

            try {
                const endpoint = stream ? 'http://localhost:8000/ask_with_stream' : 'http://localhost:8000/ask';
                const response = await fetch(endpoint, { method: 'POST', body: formData });
                
                document.getElementById('loading').classList.add('hidden');

                if (stream) {
                    const reader = response.body.getReader();
                    const decoder = new TextDecoder();
                    let buffer = '';
                    
                    while (true) {
                        const { done, value } = await reader.read();
                        if (done) break;
                        buffer += decoder.decode(value, { stream: true });
                        const lines = buffer.split('\n');
                        buffer = lines.pop() ?? '';
                        
                        for (const line of lines) {
                           if (!line.trim()) continue;
                           try {
                               const data = JSON.parse(line);
                               if (data.type === 'metadata') {
                                   document.getElementById('resEmotion').textContent = JSON.stringify(data.relevance, null, 2);
                                   document.getElementById('resQuality').textContent = JSON.stringify(data.quality, null, 2);
                               } else if (data.type === 'token') {
                                   document.getElementById('resTutor').textContent += data.content;
                               } else if (data.type === 'done') {
                                   // no-op
                               }
                           } catch (e) {
                               console.log("Stream parsing error or raw text", line);
                           }
                        }
                    }

                } else {
                    const data = await response.json();
                    document.getElementById('resEmotion').textContent = JSON.stringify(data.relevance, null, 2);
                    document.getElementById('resQuality').textContent = JSON.stringify(data.quality, null, 2);
                    document.getElementById('resTutor').textContent = data.response;
                }

            } catch (e) {
                console.error(e);
                document.getElementById('loading').textContent = "Error: " + e.message;
            }
        }

        document.getElementById('btnAsk').addEventListener('click', () => sendRequest(false));
        document.getElementById('btnStream').addEventListener('click', () => sendRequest(true));

    </script>
</body>
</html>
